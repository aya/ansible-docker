---
# file: tests/goss.yml

  - name: tests - create temporary directory
    command: mktemp -d
    register: tests_mktemp

  - name: tests - register goss installation
    environment: 
      PATH: "/usr/local/bin:{{ansible_env.PATH}}"
    command: which goss
    register: tests_goss_installed

  - name: tests - copy test files
    copy: src=goss/ dest="{{tests_mktemp.stdout}}"

  - name: tests - launch tests
    environment: 
      PATH: "/usr/local/bin:{{ansible_env.PATH}}"
    goss: path="{{tests_mktemp.stdout}}/main.yml" format=rspecish
    register: tests_goss_results
    ignore_errors: true
    become: yes

  - name: tests - remove temporary directory
    file: path="{{tests_mktemp.stdout}}" state=absent

  - name: tests - failure message
    fail: msg="{{tests_goss_results.msg}}"
    when: tests_goss_results|failed
